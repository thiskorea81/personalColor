<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 퍼스널 컬러 진단 (PDF 기획 반영)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* 비디오 및 이미지 좌우 반전 */
        .mirror-mode { transform: scaleX(-1); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center py-8 px-4">

    <div id="app" class="w-full max-w-md bg-white rounded-3xl shadow-xl overflow-hidden min-h-[600px] flex flex-col relative">
        
        <!-- Header -->
        <div class="p-4 bg-white border-b flex items-center justify-center sticky top-0 z-10">
            <h1 class="text-lg font-bold text-gray-800">퍼스널 컬러 진단</h1>
        </div>

        <!-- Content Area -->
        <div class="flex-1 flex flex-col p-6 items-center justify-center relative w-full overflow-y-auto">
            
            <!-- Step 1: Start Screen (PDF Screen 1) -->
            <div v-if="step === 'intro'" class="text-center space-y-8 w-full animate-fade-in flex flex-col items-center justify-center h-full">
                <div class="space-y-4">
                    <h2 class="text-3xl font-bold text-gray-900">AI 퍼스널 컬러 진단</h2>
                    <p class="text-gray-500">당신에게 가장 잘 어울리는 색을 찾아보세요.</p>
                </div>
                
                <div class="w-40 h-40 bg-gray-100 rounded-full flex items-center justify-center border-4 border-gray-200">
                    <i data-lucide="camera" class="w-16 h-16 text-gray-400"></i>
                </div>

                <button 
                    @click="startQuiz"
                    class="w-full max-w-xs py-4 bg-gray-900 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-gray-800 transition-all transform hover:scale-105"
                >
                    시작하기
                </button>
            </div>

            <!-- Step 2: Quiz Screen (PDF Screen 2 - 5 Questions) -->
            <div v-if="step === 'quiz'" class="w-full h-full flex flex-col animate-fade-in">
                <div class="flex justify-between items-center mb-8">
                    <span class="text-purple-600 font-bold text-lg">Q{{ currentQuestionIndex + 1 }}</span>
                    <div class="h-2 flex-1 mx-4 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full bg-purple-500 transition-all duration-300" :style="{ width: `${((currentQuestionIndex + 1) / questions.length) * 100}%` }"></div>
                    </div>
                    <span class="text-gray-400 text-sm">{{ currentQuestionIndex + 1 }}/{{ questions.length }}</span>
                </div>
                
                <h3 class="text-xl font-bold mb-8 leading-snug break-keep">
                    {{ questions[currentQuestionIndex].text }}
                </h3>

                <div class="space-y-3 flex-1 overflow-y-auto pb-4">
                    <button
                        v-for="(option, idx) in questions[currentQuestionIndex].options"
                        :key="idx"
                        @click="handleAnswer(option.score)"
                        class="w-full py-4 px-6 text-left border rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-all text-gray-700 font-medium active:scale-[0.98] flex items-center justify-between group"
                    >
                        <span>{{ option.text }}</span>
                        <div v-if="option.color" class="w-6 h-6 rounded-full border border-gray-200" :style="{ backgroundColor: option.color }"></div>
                    </button>
                </div>
            </div>

            <!-- Step 3: Camera Screen (PDF Screen 3) -->
            <div v-if="step === 'camera'" class="w-full h-full flex flex-col items-center animate-fade-in">
                <h2 class="text-xl font-bold mb-4">3단계. 피부톤 측정</h2>
                <div class="relative w-full aspect-[3/4] bg-black rounded-2xl overflow-hidden mb-6 shadow-inner">
                    <video 
                        ref="videoRef" 
                        autoplay 
                        playsinline 
                        muted
                        class="w-full h-full object-cover mirror-mode" 
                    ></video>
                    <!-- Face Guide Overlay -->
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="w-48 h-64 border-2 border-white/70 rounded-[50%] box-border z-10 shadow-[0_0_0_9999px_rgba(0,0,0,0.5)]"></div>
                        <div class="absolute text-white/90 text-sm font-medium mt-72 bg-black/50 px-3 py-1 rounded-full">
                            얼굴을 영역에 맞춰주세요
                        </div>
                    </div>
                </div>
                
                <div class="bg-yellow-50 p-3 rounded-lg text-xs text-yellow-800 mb-4 w-full text-center">
                    <i data-lucide="sun" class="w-3 h-3 inline mr-1"></i>
                    밝은 곳에서 안경/마스크를 벗고 촬영해주세요.
                </div>

                <button 
                    @click="captureImage"
                    class="w-full py-4 bg-purple-600 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-purple-700 transition-colors flex items-center justify-center gap-2"
                >
                    <i data-lucide="camera" class="w-5 h-5"></i> 사진 찍기
                </button>
            </div>

            <!-- Step 4: Result Screen (PDF Screen 4 - Zone A, B, C) -->
            <div v-if="step === 'result'" class="w-full h-full flex flex-col animate-fade-in overflow-y-auto">
                
                <!-- Zone A: Result Title -->
                <div class="text-center mb-6">
                    <span class="text-sm text-gray-500 font-medium">당신의 퍼스널 컬러는</span>
                    <h2 class="text-3xl font-extrabold text-gray-900 mt-1">{{ resultType }}</h2>
                    <p class="text-sm text-purple-600 mt-2 font-medium">{{ resultDesc }}</p>
                </div>

                <!-- Zone B: Split View (Left: Real Photo, Right: Vector Avatar) -->
                <div class="grid grid-cols-2 gap-3 mb-6 w-full aspect-[16/10]">
                    
                    <!-- Left: Captured Photo -->
                    <div class="relative rounded-2xl overflow-hidden bg-gray-200 border border-gray-100 shadow-md">
                        <img 
                            v-if="capturedImage" 
                            :src="capturedImage" 
                            class="w-full h-full object-cover mirror-mode" 
                            alt="User Face" 
                        />
                        <div class="absolute bottom-0 left-0 w-full bg-black/60 text-white text-[10px] py-1 text-center font-medium">
                            내 얼굴
                        </div>
                    </div>

                    <!-- Right: Vector Avatar (Skin Color Applied) -->
                    <div class="relative rounded-2xl overflow-hidden bg-white border border-gray-100 shadow-md flex items-end justify-center">
                        <div class="absolute top-2 right-2 flex gap-1 z-10">
                            <div class="w-3 h-3 rounded-full border border-gray-300" :style="{backgroundColor: extractedSkinColor}" title="추출된 피부색"></div>
                        </div>
                        
                        <svg viewBox="0 0 200 250" class="w-full h-full">
                            <defs>
                                <!-- Realistic Shadows -->
                                <linearGradient id="clothShadow" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:black;stop-opacity:0.0" />
                                    <stop offset="100%" style="stop-color:black;stop-opacity:0.2" />
                                </linearGradient>
                            </defs>
                            
                            <!-- Neck -->
                            <path d="M75,90 Q100,100 125,90 L125,140 L75,140 Z" :fill="extractedSkinColor" />
                            <path d="M75,90 Q100,110 125,90 L125,100 Q100,120 75,100 Z" fill="black" opacity="0.1" />

                            <!-- Face Shape (Vector) -->
                            <ellipse cx="100" cy="70" rx="38" ry="48" :fill="extractedSkinColor" />
                            
                            <!-- Simple Facial Features (Optional shadows for depth) -->
                            <!-- Ear L -->
                            <ellipse cx="62" cy="70" rx="4" ry="8" :fill="extractedSkinColor" />
                            <!-- Ear R -->
                            <ellipse cx="138" cy="70" rx="4" ry="8" :fill="extractedSkinColor" />
                            
                            <!-- Body/Clothes -->
                            <path 
                                d="M60,130 Q100,160 140,130 L180,160 L180,250 L20,250 L20,160 Z" 
                                :fill="currentSimulatedColor"
                                class="transition-colors duration-500"
                            />
                            
                            <!-- Cloth Details -->
                            <path d="M60,130 Q100,160 140,130" fill="none" stroke="black" stroke-opacity="0.1" stroke-width="1" />
                            <path d="M20,160 L30,250 L20,250 Z" fill="black" opacity="0.1" /> <!-- Side Shadow -->
                            <path d="M180,160 L170,250 L180,250 Z" fill="black" opacity="0.1" /> <!-- Side Shadow -->
                        </svg>

                        <div class="absolute bottom-0 left-0 w-full bg-purple-600/80 text-white text-[10px] py-1 text-center font-medium">
                            컬러 시뮬레이션
                        </div>
                    </div>
                </div>

                <!-- Zone C: Interaction Area (Color Recommendations) -->
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                    <h3 class="text-sm font-bold text-gray-700 mb-4 text-center">✨ 베스트 컬러를 눌러보세요</h3>
                    
                    <div class="flex justify-around items-center">
                        <div v-for="(color, idx) in bestColors" :key="idx" class="flex flex-col items-center gap-2">
                            <button 
                                @click="currentSimulatedColor = color"
                                class="w-14 h-14 rounded-full shadow-md border-2 transition-transform hover:scale-110 focus:outline-none ring-offset-2 focus:ring-2 ring-purple-500"
                                :class="{'ring-2 ring-purple-500 scale-110': currentSimulatedColor === color, 'border-white': currentSimulatedColor !== color}"
                                :style="{ backgroundColor: color }"
                            ></button>
                            <span class="text-xs font-bold text-gray-500">{{ idx + 1 }}순위</span>
                        </div>
                    </div>
                </div>

                <div class="mt-8 mb-4">
                    <button 
                        @click="resetApp"
                        class="w-full py-3 border border-gray-300 rounded-xl font-medium text-gray-600 hover:bg-gray-50 transition-colors flex items-center justify-center gap-2"
                    >
                        <i data-lucide="refresh-ccw" class="w-4 h-4"></i> 처음으로 돌아가기
                    </button>
                </div>
            </div>

        </div>
        
        <!-- Hidden Canvas -->
        <canvas ref="canvasRef" class="hidden"></canvas>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, onUpdated, nextTick } = Vue;

        createApp({
            setup() {
                const step = ref('intro'); 
                const capturedImage = ref(null);
                const extractedSkinColor = ref('#f5d0b0'); // Default Skin Color
                
                // 점수 집계: 봄, 여름, 가을, 겨울
                const scores = reactive({ spring: 0, summer: 0, autumn: 0, winter: 0 });
                // 웜/쿨 보조 점수
                const toneScore = reactive({ warm: 0, cool: 0 });

                const currentQuestionIndex = ref(0);
                const resultType = ref('');
                const resultDesc = ref('');
                const bestColors = ref([]);
                const currentSimulatedColor = ref('#eeeeee');

                const videoRef = ref(null);
                const canvasRef = ref(null);
                const streamRef = ref(null);

                // --- 2단계 질문 데이터 (PDF 기반 5개) ---
                const questions = [
                    {
                        text: "Q1. 피부가 햇볕에 타면 어떻게 되나요?",
                        options: [
                            { text: "빨갛게 달아오른다 (쿨톤 경향)", score: { type: 'tone', cool: 2 } },
                            { text: "갈색으로 변하거나 까무잡잡해진다 (웜톤 경향)", score: { type: 'tone', warm: 2 } }
                        ]
                    },
                    {
                        text: "Q2. 평소에 더 잘 어울린다고 느끼는 액세서리 색상은?",
                        options: [
                            { text: "실버 (Silver) / 화이트골드", score: { type: 'tone', cool: 2 }, color: '#C0C0C0' },
                            { text: "골드 (Gold) / 로즈골드", score: { type: 'tone', warm: 2 }, color: '#FFD700' }
                        ]
                    },
                    {
                        text: "Q3. 자주 손이 가는 옷의 색상 계열은?",
                        options: [
                            { text: "파스텔 톤 (밝고 부드러움)", score: { type: 'season', summer: 2, spring: 1 } },
                            { text: "비비드 원색 (쨍하고 선명함)", score: { type: 'season', winter: 2, spring: 1 } },
                            { text: "어두운 톤 (차분하고 깊음)", score: { type: 'season', autumn: 2, winter: 1 } },
                            { text: "아이보리/베이지 (따뜻함)", score: { type: 'season', spring: 2, autumn: 1 } }
                        ]
                    },
                    {
                        text: "Q4. 본인의 눈동자나 머리카락 색 특징은?",
                        options: [
                            { text: "매우 짙고 선명하다 (검정)", score: { type: 'season', winter: 2 } },
                            { text: "밝은 갈색이거나 붉은 기가 돈다", score: { type: 'season', spring: 2 } },
                            { text: "부드러운 초코/다크 브라운이다", score: { type: 'season', autumn: 2, summer: 1 } },
                            { text: "회색빛이 돌거나 소프트한 느낌", score: { type: 'season', summer: 2 } }
                        ]
                    },
                    {
                        text: "Q5. 가장 마음에 드는 컬러 팔레트를 선택해주세요.",
                        options: [
                            { text: "봄 (생기발랄: 코랄, 옐로우)", score: { type: 'season', spring: 3 }, color: '#FF7F50' },
                            { text: "여름 (청량함: 스카이블루, 라벤더)", score: { type: 'season', summer: 3 }, color: '#87CEEB' },
                            { text: "가을 (그윽함: 카키, 브릭레드)", score: { type: 'season', autumn: 3 }, color: '#8B4513' },
                            { text: "겨울 (모던함: 블랙, 마젠타)", score: { type: 'season', winter: 3 }, color: '#DC143C' }
                        ]
                    }
                ];

                const startQuiz = () => {
                    step.value = 'quiz';
                };

                const handleAnswer = (score) => {
                    // 점수 계산 로직
                    if (score.type === 'tone') {
                        if (score.warm) toneScore.warm += score.warm;
                        if (score.cool) toneScore.cool += score.cool;
                    } else if (score.type === 'season') {
                        if (score.spring) scores.spring += score.spring;
                        if (score.summer) scores.summer += score.summer;
                        if (score.autumn) scores.autumn += score.autumn;
                        if (score.winter) scores.winter += score.winter;
                    }

                    if (currentQuestionIndex.value < questions.length - 1) {
                        currentQuestionIndex.value++;
                    } else {
                        // 퀴즈 끝 -> 카메라 단계로 이동
                        startCamera();
                    }
                };

                // --- 카메라 로직 ---
                const startCamera = async () => {
                    step.value = 'camera';
                    await nextTick();
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: 'user' },
                            audio: false,
                        });
                        streamRef.value = stream;
                        if (videoRef.value) {
                            videoRef.value.srcObject = stream;
                        }
                    } catch (err) {
                        console.error("Camera Error:", err);
                        alert("카메라 권한이 필요합니다.");
                    }
                };

                const captureImage = () => {
                    if (!videoRef.value || !canvasRef.value) return;

                    const video = videoRef.value;
                    const canvas = canvasRef.value;
                    const ctx = canvas.getContext('2d');

                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // 좌우반전해서 그리기
                    ctx.translate(canvas.width, 0);
                    ctx.scale(-1, 1);
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                    capturedImage.value = canvas.toDataURL('image/png');
                    
                    // 카메라 중지 및 피부톤 분석
                    if (streamRef.value) streamRef.value.getTracks().forEach(t => t.stop());
                    
                    analyzeSkinAndResult(ctx, canvas.width, canvas.height);
                    step.value = 'result';
                };

                const analyzeSkinAndResult = (ctx, width, height) => {
                    // 중앙부 피부 픽셀 추출
                    const imageData = ctx.getImageData(Math.floor(width*0.4), Math.floor(height*0.4), 50, 50);
                    const data = imageData.data;
                    let r=0, g=0, b=0, count=0;
                    
                    for(let i=0; i<data.length; i+=4) {
                        r += data[i]; g += data[i+1]; b += data[i+2];
                        count++;
                    }
                    r = Math.floor(r/count);
                    g = Math.floor(g/count);
                    b = Math.floor(b/count);

                    // 추출된 피부색 저장 (오른쪽 벡터 이미지용)
                    extractedSkinColor.value = `rgb(${r}, ${g}, ${b})`;

                    // 피부톤 기반 점수 가산
                    if (r > b) {
                        scores.spring += 1;
                        scores.autumn += 1;
                    } else {
                        scores.summer += 1;
                        scores.winter += 1;
                    }

                    // 웜/쿨 퀴즈 점수 반영
                    if (toneScore.warm > toneScore.cool) {
                        scores.spring += 2;
                        scores.autumn += 2;
                    } else {
                        scores.summer += 2;
                        scores.winter += 2;
                    }

                    // 최종 결과 산출 (가장 높은 점수)
                    const maxScore = Math.max(scores.spring, scores.summer, scores.autumn, scores.winter);
                    let finalSeason = '';

                    // 동점 처리 우선순위: 본인의 퀴즈 답변 비중이 높은 순
                    if (scores.spring === maxScore) finalSeason = 'spring';
                    else if (scores.summer === maxScore) finalSeason = 'summer';
                    else if (scores.autumn === maxScore) finalSeason = 'autumn';
                    else finalSeason = 'winter';

                    setResultData(finalSeason);
                };

                const setResultData = (season) => {
                    const data = {
                        spring: {
                            title: "봄 웜톤 (Spring Warm)",
                            desc: "생기발랄하고 따뜻한 에너지가 느껴지는 타입",
                            colors: ['#FF7F50', '#FFD700', '#98FB98'] // 코랄, 골드, 연두
                        },
                        summer: {
                            title: "여름 쿨톤 (Summer Cool)",
                            desc: "청량하고 부드러운 우아함이 돋보이는 타입",
                            colors: ['#87CEEB', '#E6E6FA', '#FFB6C1'] // 스카이블루, 라벤더, 핑크
                        },
                        autumn: {
                            title: "가을 웜톤 (Autumn Warm)",
                            desc: "그윽하고 성숙한 분위기가 매력적인 타입",
                            colors: ['#8B4513', '#DAA520', '#556B2F'] // 브릭, 머스타드, 카키
                        },
                        winter: {
                            title: "겨울 쿨톤 (Winter Cool)",
                            desc: "도시적이고 세련된 카리스마가 있는 타입",
                            colors: ['#000000', '#DC143C', '#00008B'] // 블랙, 마젠타, 딥블루
                        }
                    };

                    const res = data[season];
                    resultType.value = res.title;
                    resultDesc.value = res.desc;
                    bestColors.value = res.colors;
                    currentSimulatedColor.value = res.colors[0]; // 1순위 컬러로 자동 적용
                };

                const resetApp = () => {
                    step.value = 'intro';
                    capturedImage.value = null;
                    Object.assign(scores, { spring: 0, summer: 0, autumn: 0, winter: 0 });
                    Object.assign(toneScore, { warm: 0, cool: 0 });
                    currentQuestionIndex.value = 0;
                };

                onUpdated(() => {
                    lucide.createIcons();
                });

                onMounted(() => {
                    lucide.createIcons();
                });

                return {
                    step,
                    questions,
                    currentQuestionIndex,
                    resultType,
                    resultDesc,
                    bestColors,
                    currentSimulatedColor,
                    extractedSkinColor,
                    capturedImage,
                    videoRef,
                    canvasRef,
                    startQuiz,
                    handleAnswer,
                    captureImage,
                    resetApp
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
